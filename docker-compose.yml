services:
  dns-server:
    build: .
    env_file:
      - .env
    ports:
      - "${DNS_HOST_PORT:-53}:${DNS_PORT:-53}/udp"
    volumes:
      - ${LOGS_VOLUME_PATH:-./logs}:/logs
    environment:
      - DNS_LISTEN=${DNS_LISTEN_ADDRESS:-0.0.0.0}
      - DNS_PORT=${DNS_PORT:-53}
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-dns_logs}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
    command: [
      "./dns-server",
      "-listen", "${DNS_LISTEN_ADDRESS:-0.0.0.0}",
      "-port", "${DNS_PORT:-53}",
      "-upstreams", "${DNS_UPSTREAMS:-8.8.8.8:53,1.1.1.1:53}",
      "-log", "${DNS_LOG_FILE:-/logs/dns-requests.log}",
      "-log-level", "${DNS_LOG_LEVEL:-info}",
      "-max-concurrent", "${DNS_MAX_CONCURRENT:-100}",
      "-timeout", "${DNS_TIMEOUT:-5s}",
      "-retry-attempts", "${DNS_RETRY_ATTEMPTS:-3}"
    ]
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "./dns-server", "-help"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  api-server:
    build:
      context: .
      dockerfile: Dockerfile.api
      args:
        VERSION: ${VERSION:-dev}
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
        BUILD_DATE: ${BUILD_DATE:-unknown}
    env_file:
      - .env
    ports:
      - "${API_SERVER_PORT:-8080}:8080"
    volumes:
      - ${LOGS_VOLUME_PATH:-./logs}:/logs
      - ./custom-dns.json:/app/custom-dns.json
    environment:
      - API_PORT=8080
      - DNS_LOG_FILE=${DNS_LOG_FILE:-/logs/dns-requests.log}
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-dns_logs}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
    command: [
      "./api-server",
      "-port", "8080",
      "-log-file", "${DNS_LOG_FILE:-/logs/dns-requests.log}"
    ]
    depends_on:
      dns-server:
        condition: service_started
      postgres:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    command: ["pnpm", "start", "--", "--host", "0.0.0.0"]
    env_file:
      - .env
    ports:
      - "${FRONTEND_HOST_PORT:-3000}:3000"
    environment:
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
      - WDS_SOCKET_HOST=0.0.0.0
      - WDS_SOCKET_PORT=0
      - FAST_REFRESH=false
      - REACT_APP_API_PORT=${API_SERVER_PORT:-8080}
    volumes:
      - ./frontend:/app
    depends_on:
      - api-server
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

  postgres:
    image: postgres:18-alpine
    env_file:
      - .env
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-dns_logs}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - 5432
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

volumes:
  elasticsearch-data:
    driver: local
  postgres-data:
